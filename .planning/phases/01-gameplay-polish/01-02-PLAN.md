---
phase: 01-gameplay-polish
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified: [index.html]
autonomous: false

must_haves:
  truths:
    - "On mobile, the player character renders above the finger so the thumb never obscures it"
    - "Pull-to-refresh does not trigger during gameplay on mobile browsers"
    - "Swipe-back navigation does not trigger during gameplay on Chrome Android"
    - "Pinch-to-zoom does not trigger during gameplay on iOS Safari"
    - "HUD elements (timer, brain panel, powerup bar) are not clipped by notch or home indicator on any device"
    - "The player character cannot be moved behind the notch or into the home indicator zone"
  artifacts:
    - path: "index.html"
      provides: "Touch offset, gesture prevention CSS+JS, safe area CSS+JS"
      contains: "overscroll-behavior"
  key_links:
    - from: "touchmove/touchstart handlers"
      to: "onMove()"
      via: "Y-offset subtraction on touch coordinates"
      pattern: "clientY\\s*-\\s*this\\.touchOffsetY"
    - from: "CSS :root"
      to: "env(safe-area-inset-*)"
      via: "CSS custom property bridge"
      pattern: "--sa-top.*env\\(safe-area-inset-top"
    - from: "resize()"
      to: "this.safeArea"
      via: "getComputedStyle reading CSS custom properties"
      pattern: "getComputedStyle.*--sa-top"
    - from: "player clamping in update()"
      to: "this.safeArea"
      via: "safe area margins added to clamp bounds"
      pattern: "this\\.safeArea\\.top|safeArea"
    - from: "viewport meta tag"
      to: "viewport-fit=cover"
      via: "meta content attribute"
      pattern: "viewport-fit=cover"
---

<objective>
Make mobile play feel native: finger offset prevents thumb occlusion, browser gestures are fully suppressed, and the game respects device safe areas (notch, home indicator).

Purpose: POLISH-02, POLISH-03, and POLISH-04 together ensure mobile players have a first-class experience. Currently, the player character hides under the thumb, iOS Safari allows pinch-to-zoom, pull-to-refresh can interrupt gameplay, and HUD elements ignore device notches. This plan layers CSS and JS defenses for gestures, adds a touch Y-offset, and integrates safe area insets into both CSS positioning and JS canvas clamping.

Output: Modified index.html with touch offset, layered gesture prevention, safe area CSS variables, HUD safe area positioning, and JS-side safe area clamping for player movement.
</objective>

<execution_context>
@C:\Users\Zahi\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\Zahi\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@C:\Users\Zahi\claudecode\dodge-ai\.planning\PROJECT.md
@C:\Users\Zahi\claudecode\dodge-ai\.planning\ROADMAP.md
@C:\Users\Zahi\claudecode\dodge-ai\.planning\STATE.md
@C:\Users\Zahi\claudecode\dodge-ai\.planning\phases\01-gameplay-polish\01-RESEARCH.md
@C:\Users\Zahi\claudecode\dodge-ai\.planning\phases\01-gameplay-polish\01-01-SUMMARY.md
@C:\Users\Zahi\claudecode\dodge-ai\index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Touch offset, gesture prevention, and safe area integration</name>
  <files>index.html</files>
  <action>
This task modifies CSS, the viewport meta tag, touch input handlers, resize(), player clamping, and adds gesture prevention JS. All changes are in index.html.

**1. Viewport meta tag (line 5):**

Change:
```html
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
```
To:
```html
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
```

**2. CSS safe area variables and gesture prevention:**

Add to the `:root` / `html` level (before the `*` reset or right after `<style>`):
```css
:root {
  --sa-top: env(safe-area-inset-top, 0px);
  --sa-bottom: env(safe-area-inset-bottom, 0px);
  --sa-left: env(safe-area-inset-left, 0px);
  --sa-right: env(safe-area-inset-right, 0px);
}

html {
  overscroll-behavior: none;
}
```

Add `overscroll-behavior: none;` to the existing `body` styles (after `cursor: default` on line 22).

**3. HUD safe area positioning:**

Update `#hud` (currently `top: 16px; left: 16px`):
```css
#hud {
  top: max(16px, calc(8px + var(--sa-top)));
  left: max(16px, calc(8px + var(--sa-left)));
}
```

Update `#brain-panel` (currently `top: 16px; right: 16px`):
```css
#brain-panel {
  top: max(16px, calc(8px + var(--sa-top)));
  right: max(16px, calc(8px + var(--sa-right)));
}
```

Update `#hud-powerups` (currently `bottom: 16px`):
```css
#hud-powerups {
  bottom: max(16px, calc(8px + var(--sa-bottom)));
}
```

Update the mobile media query (~line 569-577) to also use safe area:
```css
@media (max-width: 600px) {
  #brain-panel { width: 150px; padding: 8px; top: max(8px, calc(4px + var(--sa-top))); right: max(8px, calc(4px + var(--sa-right))); }
  #hud { top: max(8px, calc(4px + var(--sa-top))); left: max(8px, calc(4px + var(--sa-left))); }
  /* ... keep existing font-size overrides unchanged ... */
}
```

**4. Touch offset in setupInput() (~line 1642):**

Add a `touchOffsetY` property. Initialize it in the constructor or start(): `this.touchOffsetY = 50;`

Modify the touchmove and touchstart handlers to subtract the offset from Y:
```javascript
this.canvas.addEventListener('touchmove', e => {
  e.preventDefault();
  onMove(e.touches[0].clientX, e.touches[0].clientY - this.touchOffsetY);
}, { passive: false });

this.canvas.addEventListener('touchstart', e => {
  e.preventDefault();
  onMove(e.touches[0].clientX, e.touches[0].clientY - this.touchOffsetY);
}, { passive: false });
```

Do NOT modify the mousemove handler -- mouse input stays un-offset.

**5. Gesture prevention JS (add in setupInput() or constructor):**

Add these document-level event listeners (place after setupInput's existing canvas listeners, or in the constructor after setupInput is called):
```javascript
// iOS Safari pinch-to-zoom prevention
document.addEventListener('gesturestart', e => e.preventDefault(), { passive: false });
document.addEventListener('gesturechange', e => e.preventDefault(), { passive: false });
document.addEventListener('gestureend', e => e.preventDefault(), { passive: false });

// Additional pinch prevention via multi-touch scale check
document.addEventListener('touchmove', e => {
  if (e.scale !== undefined && e.scale !== 1) {
    e.preventDefault();
  }
}, { passive: false });
```

IMPORTANT: This document-level touchmove listener is SEPARATE from the canvas touchmove listener. The canvas listener handles game input. This document listener only prevents pinch-to-zoom and should NOT interfere with single-finger touches (the `e.scale !== 1` check ensures this).

**6. Safe area reading in resize() (~line 1635):**

Add safe area reading at the end of `resize()`:
```javascript
resize() {
  this.canvas.width = window.innerWidth;
  this.canvas.height = window.innerHeight;
  this.w = this.canvas.width;
  this.h = this.canvas.height;

  // Read safe area insets for canvas-side clamping
  const style = getComputedStyle(document.documentElement);
  this.safeArea = {
    top: parseFloat(style.getPropertyValue('--sa-top')) || 0,
    bottom: parseFloat(style.getPropertyValue('--sa-bottom')) || 0,
    left: parseFloat(style.getPropertyValue('--sa-left')) || 0,
    right: parseFloat(style.getPropertyValue('--sa-right')) || 0,
  };
}
```

Initialize `this.safeArea = { top: 0, bottom: 0, left: 0, right: 0 };` in the constructor so it's available before the first resize.

**7. Player clamping with safe area (~line 1842):**

Update the player position clamping to incorporate safe area:
```javascript
const pr = this.getPlayerRadius();
const sa = this.safeArea;
this.player.x = Math.max(pr + sa.left, Math.min(this.w - pr - sa.right, this.player.x));
this.player.y = Math.max(pr + sa.top, Math.min(this.h - pr - sa.bottom, this.player.y));
```

This prevents the player from moving behind the notch or into the home indicator zone.

**8. Powerup spawn margin with safe area (~line 2083):**

The powerup spawning uses `margin = 60`. Update it to also account for safe area:
```javascript
const margin = 60;
const sa = this.safeArea;
const x = margin + sa.left + Math.random() * (this.w - 2 * margin - sa.left - sa.right);
const y = margin + sa.top + Math.random() * (this.h - 2 * margin - sa.top - sa.bottom);
```

This ensures powerups don't spawn behind the notch where they'd be invisible.
  </action>
  <verify>
1. Open index.html in browser -- game loads and plays normally on desktop (no regressions from safe area/gesture changes)
2. Check CSS: search for `overscroll-behavior: none` -- should appear on both `html` and `body`
3. Check CSS: search for `--sa-top` -- should appear in `:root` declaration and in `resize()` JS
4. Check CSS: search for `viewport-fit=cover` -- should be in the meta tag
5. Check JS: search for `touchOffsetY` -- should appear in constructor/start and both touch handlers
6. Check JS: search for `gesturestart` -- should have 3 gesture event listeners
7. Check JS: search for `this.safeArea` -- should be initialized in constructor and populated in resize()
8. Check JS: player clamping uses `sa.top`, `sa.bottom`, `sa.left`, `sa.right`
9. No JavaScript console errors on desktop
  </verify>
  <done>Touch offset subtracts 50px from Y on touch input only. overscroll-behavior:none on html+body. Gesture prevention JS for iOS pinch. viewport-fit=cover in meta tag. Safe area CSS variables bridge to JS. HUD elements use max() with safe area insets. Player clamping respects safe areas. Powerup spawning respects safe areas.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify mobile experience</name>
  <what-built>
Complete mobile polish: touch finger offset (50px above touch point), browser gesture prevention (pull-to-refresh, swipe-back, pinch-to-zoom), and safe area support (notch, home indicator). Plus death indicator from Plan 01.
  </what-built>
  <how-to-verify>
Test on a mobile device (or Chrome DevTools mobile emulation with touch simulation):

1. **Death indicator (from Plan 01):** Play and die. During the death animation, you should see a highlighted ring around the killer projectile, a red arrow from your position to the killer, and the killer's type label. On the game-over screen, "Killed by: [TYPE] from the [direction]" should appear.

2. **Touch offset (POLISH-02):** Touch and drag on mobile. The player character should appear ~50px ABOVE your finger, not directly under it. Your thumb should never cover the player.

3. **Gesture prevention (POLISH-03):** While playing, try:
   - Pull down to refresh -- should NOT trigger refresh
   - Swipe from left edge -- should NOT trigger browser back
   - Pinch with two fingers -- should NOT zoom the page

4. **Safe areas (POLISH-04):** If testing on a notched device (iPhone with notch/Dynamic Island, or Android with punch-hole), verify:
   - HUD timer (top-left) is not behind the notch
   - Brain panel (top-right) is not behind the notch
   - Powerup indicators (bottom) are not behind the home indicator bar
   - Player cannot be dragged behind the notch area
   - If no notched device available, verify HUD still has reasonable padding (not flush against edges)

5. **No regressions:** Desktop mouse input works normally (no offset). Game starts, plays, dies, retries correctly on both desktop and mobile.
  </how-to-verify>
  <resume-signal>Type "approved" if mobile experience feels right, or describe any issues (offset feels wrong, gestures still triggering, HUD positioning off, etc.)</resume-signal>
</task>

</tasks>

<verification>
1. Desktop: Game plays identically to before (mouse input unchanged, no safe area artifacts on non-notched screens)
2. Mobile touch: Player renders above finger, not under it
3. Mobile gestures: Pull-to-refresh, swipe-back, and pinch-to-zoom all suppressed
4. Notched devices: HUD elements respect safe areas, player cannot enter unsafe zones
5. Game-over screen from Plan 01: Death info displays correctly
6. No console errors on any device
</verification>

<success_criteria>
- Touch Y-offset of 50px applied to touchmove and touchstart only (not mouse)
- overscroll-behavior:none on both html and body elements
- gesturestart/gesturechange/gestureend prevention JS present
- viewport-fit=cover in viewport meta tag
- Safe area CSS custom properties (--sa-top etc.) declared in :root
- HUD elements (#hud, #brain-panel, #hud-powerups) use max() with safe area vars
- resize() reads safe area values into this.safeArea
- Player clamping incorporates safe area margins
- Powerup spawning incorporates safe area margins
- Human verification confirms mobile experience feels native
</success_criteria>

<output>
After completion, create `.planning/phases/01-gameplay-polish/01-02-SUMMARY.md`
</output>
