---
phase: 01-gameplay-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [index.html]
autonomous: true

must_haves:
  truths:
    - "When the player dies, the screen briefly freezes showing which projectile or boss killed them"
    - "A directional arrow points from the player to the killer during the freeze frame"
    - "The killer entity is highlighted with a bright ring and its type label is visible"
    - "The game-over screen shows text describing what killed the player and from which direction"
  artifacts:
    - path: "index.html"
      provides: "Death context capture, freeze-frame rendering, game-over kill info"
      contains: "deathContext"
  key_links:
    - from: "collision detection (projectile loop)"
      to: "this.deathContext"
      via: "property assignment before die() call"
      pattern: "this\\.deathContext\\s*=.*type.*projectile"
    - from: "collision detection (boss loop)"
      to: "this.deathContext"
      via: "property assignment before die() call"
      pattern: "this\\.deathContext\\s*=.*type.*boss"
    - from: "renderDeathFrame()"
      to: "this.deathContext"
      via: "reads deathContext to draw arrow and highlight"
      pattern: "renderDeathIndicator|deathContext"
    - from: "showGameOver()"
      to: "this.deathContext"
      via: "reads deathContext to display kill text"
      pattern: "deathContext\\.subtype|deathContext\\.bossName"
---

<objective>
Add death context capture and visual kill indicator so players always know what killed them and from which direction.

Purpose: POLISH-01 requires that every death feels earned. Currently, die() captures zero information about the killing entity. Players have no idea what hit them, especially in chaotic later phases with 6+ projectile types on screen. This plan captures the killer's identity at collision time, shows a brief freeze-frame with directional arrow and killer highlight, and adds kill info text to the game-over screen.

Output: Modified index.html with deathContext capture at all 4 collision points, freeze-frame visual indicator, and game-over screen kill text.
</objective>

<execution_context>
@C:\Users\Zahi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Zahi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@C:\Users\Zahi\claudecode\dodge-ai\.planning\PROJECT.md
@C:\Users\Zahi\claudecode\dodge-ai\.planning\ROADMAP.md
@C:\Users\Zahi\claudecode\dodge-ai\.planning\STATE.md
@C:\Users\Zahi\claudecode\dodge-ai\.planning\phases\01-gameplay-polish\01-RESEARCH.md
@C:\Users\Zahi\claudecode\dodge-ai\index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Capture death context at all collision points</name>
  <files>index.html</files>
  <action>
At every collision point that calls `this.die()`, capture a `deathContext` object BEFORE calling die(). There are exactly 4 die() calls to modify:

1. **Projectile collision** (~line 1932): Inside the projectile loop where `dist < hitDist` and neither ghost nor shield is active. Before `this.die()`, add:
```javascript
this.deathContext = {
  type: 'projectile',
  subtype: p.type,
  homing: p.homing || false,
  color: p.color,
  x: p.x,
  y: p.y,
  vx: p.vx,
  vy: p.vy,
  angle: Math.atan2(p.y - this.player.y, p.x - this.player.x),
  playerX: this.player.x,
  playerY: this.player.y,
  bossName: null,
};
```

2. **Boss collision** (~line 2018): Inside the boss loop where `bossCollided` is true and neither ghost nor shield is active. Before `this.die()`, add:
```javascript
this.deathContext = {
  type: 'boss',
  subtype: boss.bossType?.shape || 'boss',
  homing: false,
  color: boss.color,
  x: boss.x,
  y: boss.y,
  vx: 0,
  vy: 0,
  angle: Math.atan2(boss.y - this.player.y, boss.x - this.player.x),
  playerX: this.player.x,
  playerY: this.player.y,
  bossName: boss.bossType?.name || 'Unknown Boss',
};
```

Also initialize `this.deathContext = null` in the `start()` method (where other game state is reset) and in the constructor.

Verify there are no other places `this.die()` is called by searching the file -- the research identified exactly 4 locations (2 projectile, 2 boss paths), but confirm this.
  </action>
  <verify>
Search index.html for all occurrences of `this.die()` -- each one must be preceded by a `this.deathContext = {` assignment. Search for `deathContext` -- should appear at least 6 times (2 projectile captures + 2 boss captures + init in start + init in constructor).
  </verify>
  <done>Every call to this.die() is preceded by a deathContext capture with type, subtype, color, position, angle, and playerX/playerY. deathContext is reset to null on game start.</done>
</task>

<task type="auto">
  <name>Task 2: Render death freeze-frame indicator and add kill info to game-over screen</name>
  <files>index.html</files>
  <action>
**Part A: Freeze-frame visual indicator**

Modify `renderDeathFrame()` (~line 2482) to draw a death indicator overlay during the death animation. Add a new method `renderDeathIndicator(ctx)` to the Game class and call it from `renderDeathFrame()` right after drawing projectiles/shockwaves/particles but before the deathAnim loop starts.

`renderDeathIndicator(ctx)` should:
1. Return early if `this.deathContext` is null
2. Draw a pulsing white ring (strokeStyle '#fff', lineWidth 3, globalAlpha 0.8) around the killer at `(deathContext.x, deathContext.y)` with radius 15 for projectiles or 35 for bosses
3. Draw an arrow line (strokeStyle '#ff3355', lineWidth 2, globalAlpha 0.6) from player position to killer position
4. Draw an arrowhead at the killer end using the deathContext.angle (headLen = 12, spread = 0.4 radians)
5. Draw a label above the killer showing the subtype in uppercase (or bossName for bosses) using the killer's color, font 'bold 11px Courier New', textAlign 'center', positioned 20px above the killer
6. Reset globalAlpha to 1 when done

Also draw the death indicator in the first few frames of the `deathAnim` loop (add a `deathIndicatorFrames` counter, start at 20, decrement each frame, only draw indicator while > 0). This keeps the indicator visible during the particle fade-out animation, not just the initial frame.

Keep the freeze frame brief -- the existing 600ms setTimeout before game-over is the window. The indicator renders alongside the death particles, not as a separate pause. Do NOT add any extra delay to the death flow.

**Part B: Kill info text in game-over screen**

In `showGameOver()` (~line 2510), after the existing AI learned text, add a line showing what killed the player. Add a new `<div>` to the game-over screen HTML (id="go-killed-by") styled with font-size 12px, color matching the killer's color, margin-top 8px, letter-spacing 1px.

In `showGameOver()`, populate it:
```javascript
const killedByEl = document.getElementById('go-killed-by');
if (this.deathContext) {
  const d = this.deathContext;
  const directionName = getDirectionName(d.angle); // helper function
  const killerName = d.bossName || d.subtype.toUpperCase();
  killedByEl.textContent = `Killed by: ${killerName} from the ${directionName}`;
  killedByEl.style.color = d.color;
  killedByEl.style.display = 'block';
} else {
  killedByEl.style.display = 'none';
}
```

Add a helper function `getDirectionName(angle)` that converts a radian angle to a cardinal/ordinal direction string (right, upper-right, above, upper-left, left, lower-left, below, lower-right) using 8 sectors of 45 degrees each. Place this as a standalone function near the top of the script block (not as a class method -- it's a pure utility).

**CSS for the killed-by element:**

Add to the gameover screen styles:
```css
#go-killed-by {
  font-size: 12px;
  letter-spacing: 1px;
  margin-top: 10px;
  font-family: 'Courier New', monospace;
  text-transform: uppercase;
}
```

Place the `<div id="go-killed-by"></div>` in the game-over screen HTML, right after the `go-ai-learned` div.
  </action>
  <verify>
1. Open index.html in browser, play the game, and die. During the ~600ms death animation, a white ring should highlight the killer and a red arrow should point from where the player was to the killer. The killer's type label should appear above it.
2. On the game-over screen, a "Killed by: [TYPE] from the [direction]" line should appear below the AI learned text, colored to match the killer projectile.
3. Search for `renderDeathIndicator` in the file -- should exist as a method.
4. Search for `go-killed-by` -- should appear in both HTML and JS.
5. Search for `getDirectionName` -- should exist as a utility function.
  </verify>
  <done>Death freeze-frame shows directional arrow pointing to highlighted killer with type label. Game-over screen displays "Killed by: [TYPE] from the [direction]" text. Both projectile and boss deaths show correct kill info.</done>
</task>

</tasks>

<verification>
1. Play the game on desktop, die to a projectile: see freeze-frame indicator (ring, arrow, label) and game-over kill text
2. If possible, survive to a boss phase and die to a boss: verify boss name appears instead of projectile subtype
3. The death flow timing feels unchanged -- no perceptible extra delay before game-over screen appears
4. Multiple deaths show different projectile types and directions correctly
5. No JavaScript console errors
</verification>

<success_criteria>
- deathContext captured at all collision points (projectile and boss)
- Freeze-frame renders directional arrow + killer highlight + type label during 600ms death animation
- Game-over screen shows "Killed by: [TYPE] from the [direction]" with correct color
- Death flow timing unchanged (still 600ms before game-over)
- No regressions: game starts, runs, dies, retries correctly
</success_criteria>

<output>
After completion, create `.planning/phases/01-gameplay-polish/01-01-SUMMARY.md`
</output>
