---
phase: 02-ai-intelligence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [index.html]
autonomous: true

must_haves:
  truths:
    - "During gameplay, floating text callouts appear when the AI detects patterns, with smug adversarial personality"
    - "Messages have a cooldown (8-12s) so they never spam -- max 1 visible at a time"
    - "Counter-attack warnings have higher priority than general detection messages"
    - "Returning players see a welcome-back taunt referencing their past habits on game start"
    - "AI learning messages persist as a DOM toast element positioned for visibility without blocking gameplay"
  artifacts:
    - path: "index.html"
      provides: "AI callout toast system, message queue with priority/cooldown, welcome-back taunt logic, expanded localStorage profile"
      contains: "ai-callout"
  key_links:
    - from: "showLearningMessage()"
      to: "#ai-callout DOM element"
      via: "classList toggle with CSS transition"
      pattern: "ai-callout.*show"
    - from: "start()"
      to: "showWelcomeBack()"
      via: "called after brain.load() for returning players"
      pattern: "showWelcomeBack|sessionsPlayed"
    - from: "brain.save()"
      to: "localStorage"
      via: "expanded save data with sessionsPlayed, lastPlayedAt, dominantPatterns"
      pattern: "sessionsPlayed|lastPlayedAt|dominantPatterns"
---

<objective>
Build the AI visibility layer: a toast callout system for learning messages, a priority queue with cooldown to prevent spam, welcome-back taunts for returning players, and expanded localStorage persistence to track session history.

Purpose: AI-01 requires visible learning messages during gameplay. The locked decision demands explicit adversarial callouts ("Targeting your safe zone", "Detected clockwise pattern"). This plan creates the infrastructure that Plans 02 and 03 will populate with actual pattern detections. Without this visibility layer, the AI's intelligence is invisible and the core differentiator is lost.

Output: Modified index.html with ai-callout DOM element, CSS styles, showLearningMessage() method with priority queue and cooldown, welcome-back taunt system, and expanded brain save/load for cross-session profile data.
</objective>

<execution_context>
@C:\Users\Zahi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Zahi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@C:\Users\Zahi\claudecode\dodge-ai\.planning\PROJECT.md
@C:\Users\Zahi\claudecode\dodge-ai\.planning\ROADMAP.md
@C:\Users\Zahi\claudecode\dodge-ai\.planning\STATE.md
@C:\Users\Zahi\claudecode\dodge-ai\.planning\phases\02-ai-intelligence\02-RESEARCH.md
@C:\Users\Zahi\claudecode\dodge-ai\index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add AI callout toast DOM element, CSS, and showLearningMessage() method</name>
  <files>index.html</files>
  <action>
**Part A: DOM element**

Add a new `<div id="ai-callout"></div>` to the HTML, after the `#pickup-announce` div (around line 665). This is the floating toast element for AI learning messages.

**Part B: CSS styles**

Add CSS for `#ai-callout` in the existing style block (after the `#pickup-announce.show` rule, around line 286). Style it to match the brain panel's purple personality:

```css
#ai-callout {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 15;
  font-size: 13px;
  color: #c4b5fd;
  letter-spacing: 1px;
  text-align: center;
  max-width: 320px;
  padding: 8px 16px;
  background: rgba(139, 92, 246, 0.1);
  border: 1px solid rgba(139, 92, 246, 0.2);
  border-radius: 6px;
  opacity: 0;
  transition: opacity 0.4s;
  pointer-events: none;
  font-family: 'Courier New', monospace;
  text-transform: uppercase;
}

#ai-callout.show { opacity: 1; }

#ai-callout.type-counter { color: #f87171; border-color: rgba(248, 113, 113, 0.3); background: rgba(248, 113, 113, 0.08); }
#ai-callout.type-welcome { color: #a78bfa; border-color: rgba(167, 139, 250, 0.3); background: rgba(167, 139, 250, 0.1); }
#ai-callout.type-taunt { color: #fbbf24; border-color: rgba(251, 191, 36, 0.2); background: rgba(251, 191, 36, 0.06); }
```

Add mobile adjustment inside the existing `@media (max-width: 600px)` block:
```css
#ai-callout { font-size: 11px; max-width: 240px; }
```

**Part C: showLearningMessage() method on Game class**

Add `showLearningMessage(type, text)` method to the Game class (after `updateUI()`, before the closing `}` of the class around line 2932). This method manages the callout toast with priority and cooldown.

```javascript
showLearningMessage(type, text) {
  // type: 'detect', 'counter', 'taunt', 'welcome'
  // Priority order: counter > detect > taunt (welcome bypasses cooldown)
  const now = this.gameTime || 0;
  const priority = { counter: 3, detect: 2, welcome: 2, taunt: 1 };

  // Respect cooldown (welcome messages bypass it)
  if (type !== 'welcome' && this._lastCalloutTime && (now - this._lastCalloutTime) < this._calloutCooldown) {
    // Queue if higher priority than current showing message
    if ((priority[type] || 0) <= (priority[this._currentCalloutType] || 0)) return;
  }

  // Suppress repeated message types after 3 occurrences of the same type in this run
  if (type !== 'welcome') {
    this._calloutTypeCounts = this._calloutTypeCounts || {};
    const key = type + ':' + text.slice(0, 20);
    this._calloutTypeCounts[key] = (this._calloutTypeCounts[key] || 0) + 1;
    if (this._calloutTypeCounts[key] > 3) return;
  }

  const el = document.getElementById('ai-callout');
  if (!el) return;

  // Clear previous
  el.classList.remove('show', 'type-counter', 'type-welcome', 'type-taunt', 'type-detect');

  // Set content and type-specific styling
  el.textContent = text;
  el.classList.add('type-' + type);

  // Force reflow then show
  void el.offsetWidth;
  el.classList.add('show');

  this._lastCalloutTime = now;
  this._currentCalloutType = type;
  this._calloutCooldown = 8 + Math.random() * 4; // 8-12 seconds

  // Auto-hide after 3 seconds
  clearTimeout(this._calloutTimer);
  this._calloutTimer = setTimeout(() => {
    el.classList.remove('show');
    this._currentCalloutType = null;
  }, 3000);
}
```

Also initialize callout state in `start()` method (around line 1812, after `this.deathContext = null`):
```javascript
this._lastCalloutTime = 0;
this._currentCalloutType = null;
this._calloutCooldown = 0;
this._calloutTypeCounts = {};
clearTimeout(this._calloutTimer);
```

And hide the callout on game over -- in `die()` (around line 2547), add after `this.running = false`:
```javascript
const calloutEl = document.getElementById('ai-callout');
if (calloutEl) calloutEl.classList.remove('show');
```
  </action>
  <verify>
1. Search index.html for `ai-callout` -- should appear in HTML, CSS (multiple rules), and JS (showLearningMessage method)
2. Search for `showLearningMessage` -- should exist as a method on the Game class
3. Search for `_lastCalloutTime` -- should appear in start() initialization and in showLearningMessage()
4. Open in browser, open console, run: `window._game.showLearningMessage('detect', 'Test message')` -- should see a purple toast appear center-screen and fade after 3s
  </verify>
  <done>AI callout toast element exists with CSS transitions, type-specific color variants, priority system, 8-12s cooldown, max 3 per message type per run, and auto-hide after 3 seconds. Callout state resets on game start and hides on death.</done>
</task>

<task type="auto">
  <name>Task 2: Expand brain persistence and add welcome-back taunt system</name>
  <files>index.html</files>
  <action>
**Part A: Expand AIBrain.save() and load()**

Modify `save()` (line 942) to include cross-session profile data. The save format gains a version field and new properties:

```javascript
save() {
  try {
    const existing = JSON.parse(localStorage.getItem('dodge-ai-brain')) || {};
    const sessionsPlayed = (existing.sessionsPlayed || 0) + 1;

    // Determine dominant patterns for welcome-back taunts
    const dominantPatterns = [];
    const dom = this.getDominantDodge();
    if (dom && dom.pct > 30) dominantPatterns.push(dom.direction + '-dodge');
    const favZoneIdx = this.zoneVisits.indexOf(Math.max(...this.zoneVisits));
    const zoneNames = ['top-left', 'top-center', 'top-right', 'mid-left', 'center', 'mid-right', 'bottom-left', 'bottom-center', 'bottom-right'];
    if (this.zoneVisits[favZoneIdx] > 20) dominantPatterns.push(zoneNames[favZoneIdx] + '-zone');

    localStorage.setItem('dodge-ai-brain', JSON.stringify({
      version: 2,
      directionBias: this.directionBias,
      totalSamples: this.totalSamples,
      reactionSamples: this.reactionSamples.slice(-20),
      zoneVisits: this.zoneVisits,
      sessionsPlayed: sessionsPlayed,
      lastPlayedAt: Date.now(),
      dominantPatterns: dominantPatterns.slice(0, 3),
    }));
  } catch (e) {}
}
```

Modify `load()` (line 953) to read the expanded data and expose it via a `getSavedProfile()` method:

```javascript
load() {
  try {
    const data = JSON.parse(localStorage.getItem('dodge-ai-brain'));
    if (data) {
      this.directionBias = data.directionBias || this.directionBias;
      this.totalSamples = data.totalSamples || 0;
      this.reactionSamples = data.reactionSamples || [];
      this.zoneVisits = data.zoneVisits || new Array(9).fill(0);
      // Cross-session profile
      this._savedProfile = {
        sessionsPlayed: data.sessionsPlayed || 0,
        lastPlayedAt: data.lastPlayedAt || 0,
        dominantPatterns: data.dominantPatterns || [],
      };
    }
  } catch (e) {}
}

getSavedProfile() {
  return this._savedProfile || null;
}
```

Initialize `this._savedProfile = null` in the AIBrain constructor (line 813, after other initializations).

**Part B: Welcome-back taunt system**

Add `showWelcomeBack()` method to the Game class (near `showLearningMessage`):

```javascript
showWelcomeBack() {
  const profile = this.brain.getSavedProfile();
  if (!profile || profile.sessionsPlayed < 1) return;

  const patterns = profile.dominantPatterns || [];
  const sessions = profile.sessionsPlayed;

  // Templates with pattern references
  const withPattern = [
    (p) => `Oh, you're back. Still ${p.replace('-', ' ')}ing?`,
    (p) => `Session ${sessions + 1}. I still remember your ${p.replace('-dodge', '').replace('-zone', ' zone')} habit.`,
    (p) => `Return of the ${p.replace('-dodge', ' dodger').replace('-zone', ' zone camper')}. My aim has improved.`,
  ];

  // Generic templates (no pattern data needed)
  const generic = [
    () => `Missed you. Well, not literally. I never miss.`,
    () => `Back for more? Your pattern data is still warm.`,
    () => `Session ${sessions + 1}. Your patterns haven't changed. Mine have.`,
  ];

  let msg;
  if (patterns.length > 0) {
    const template = withPattern[Math.floor(Math.random() * withPattern.length)];
    msg = template(patterns[0]);
  } else {
    const template = generic[Math.floor(Math.random() * generic.length)];
    msg = template();
  }

  // Show with a slight delay so the game has started visually
  setTimeout(() => {
    if (this.running) this.showLearningMessage('welcome', msg);
  }, 1500);
}
```

Call `this.showWelcomeBack()` in the `start()` method (around line 1824), right after `this.announcePhase()`:
```javascript
this.announcePhase();
this.showWelcomeBack();
```

**Part C: Reset AI button must clear expanded data**

The existing reset handler at line 1757 does `localStorage.removeItem('dodge-ai-brain')` and `this.brain = new AIBrain()`. This already works correctly because removing the key and creating a new AIBrain means load() finds nothing. No changes needed here -- just verify it still works.
  </action>
  <verify>
1. Search for `sessionsPlayed` -- should appear in save(), load(), getSavedProfile(), and showWelcomeBack()
2. Search for `getSavedProfile` -- should be a method on AIBrain
3. Search for `showWelcomeBack` -- should be a method on Game, called from start()
4. Search for `dominantPatterns` -- should appear in save() and load()
5. Open in browser, play a game, die (triggers save). Refresh page, start a new game -- welcome-back taunt should appear ~1.5 seconds into the game as a floating callout
6. Click RESET AI, start game -- no welcome-back taunt should appear
  </verify>
  <done>AIBrain save/load expanded with version 2 schema including sessionsPlayed, lastPlayedAt, and dominantPatterns. Welcome-back taunt system shows returning players a smug message referencing their past habits. Profile data resets correctly via Reset AI button.</done>
</task>

</tasks>

<verification>
1. Start a fresh game (clear localStorage first): no welcome-back message appears
2. Play, die, then start a new game: welcome-back taunt appears ~1.5s into gameplay as a centered floating callout with purple styling
3. The callout auto-hides after ~3 seconds
4. Run `window._game.showLearningMessage('counter', 'Targeting your safe zone.')` in console -- red-tinted callout appears
5. Run `window._game.showLearningMessage('taunt', 'Still predictable.')` in console -- yellow-tinted callout appears
6. Rapid-fire multiple calls within 1 second -- only the highest-priority message shows, cooldown prevents spam
7. No JavaScript console errors
8. Mobile viewport (375px wide): callout text is smaller and narrower, still readable
</verification>

<success_criteria>
- AI callout toast element exists with CSS transitions and type-specific color variants
- showLearningMessage() enforces 8-12s cooldown, priority ordering, and max 3 per type per run
- Welcome-back taunt shows for returning players (sessionsPlayed >= 1) referencing stored dominant patterns
- Brain save/load expanded to version 2 schema with sessionsPlayed, lastPlayedAt, dominantPatterns
- Callout state resets on game start, hides on death
- No regressions: game starts, runs, dies, retries correctly
</success_criteria>

<output>
After completion, create `.planning/phases/02-ai-intelligence/02-01-SUMMARY.md`
</output>
