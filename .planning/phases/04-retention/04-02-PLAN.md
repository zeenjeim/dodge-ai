---
phase: 04-retention
plan: 02
type: execute
wave: 2
depends_on: [04-01]
files_modified: [index.html]
autonomous: true

must_haves:
  truths:
    - "Stats modal shows a 'Personal Bests' section with top 5 survival times and their dates"
    - "Existing players' single best time (dodge-ai-best) is migrated into the new top 5 list on first load"
    - "New best times are added to the list after each death (if they qualify for top 5)"
    - "Each entry in the personal best list shows the time, date, and a small indicator if it was a daily challenge"
    - "The start screen still shows the single best time (reads from the new array)"
    - "Share card shows a small DAILY CHALLENGE badge when generated after a daily game"
  artifacts:
    - path: "index.html"
      provides: "Personal best list in localStorage, migration from old format, stats modal display, share card daily badge"
      contains: "dodge-ai-bests"
  key_links:
    - from: "die()"
      to: "saveBest()"
      via: "Every death saves game time to personal best list"
      pattern: "saveBest"
    - from: "migrateBestTime()"
      to: "localStorage dodge-ai-bests"
      via: "One-time migration of dodge-ai-best to new array format"
      pattern: "migrateBestTime"
    - from: "stats modal onclick"
      to: "loadBests()"
      via: "Stats modal reads and displays the top 5 list"
      pattern: "loadBests"
    - from: "generateShareCard()"
      to: "isDailyChallenge"
      via: "Conditional DAILY CHALLENGE badge on share card"
      pattern: "isDailyChallenge.*DAILY"
---

<objective>
Add personal best list tracking (top 5 survival times with dates) and integrate it into the stats modal, start screen, and share card. Migrate existing single best time to the new format.

Purpose: A visible personal best list gives players a tangible history of improvement, motivating return visits. Seeing past times and dates creates a personal narrative. The daily badge on the share card makes daily challenges more shareable.
Output: index.html with personal best list management (load, save, migrate), enhanced stats modal, and daily badge on share card.
</objective>

<execution_context>
@C:\Users\Zahi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Zahi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-retention/04-RESEARCH.md
@.planning/phases/04-retention/04-01-SUMMARY.md
@index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add personal best list management and migration</name>
  <files>index.html</files>
  <action>
**1. Add personal best list utility functions** near the other utility functions (near fnv1aHash/mulberry32 from Plan 01):

```javascript
const BESTS_KEY = 'dodge-ai-bests';
const MAX_BESTS = 5;

function loadBests() {
  try {
    return JSON.parse(localStorage.getItem(BESTS_KEY)) || [];
  } catch { return []; }
}

function saveBest(gameTime, isDaily) {
  const bests = loadBests();
  bests.push({
    time: parseFloat(gameTime.toFixed(1)),
    date: getTodayUTC(),
    daily: isDaily,
  });
  bests.sort((a, b) => b.time - a.time);
  const top5 = bests.slice(0, MAX_BESTS);
  localStorage.setItem(BESTS_KEY, JSON.stringify(top5));
  return top5;
}

function migrateBestTime() {
  const oldBest = parseFloat(localStorage.getItem('dodge-ai-best'));
  const newBests = localStorage.getItem(BESTS_KEY);
  if (oldBest > 0 && !newBests) {
    localStorage.setItem(BESTS_KEY, JSON.stringify([{
      time: oldBest,
      date: 'legacy',
      daily: false,
    }]));
  }
}
```

**2. Call migrateBestTime() early** -- in the Game constructor, after the existing localStorage reads for totalGames and bestTime (~line 2150), add:
```javascript
migrateBestTime();
```

**3. Update die() to save to personal best list** -- After the existing best time check (`if (isNewBest)` block, ~line 3154-3158), add:
```javascript
saveBest(this.gameTime, this.isDailyChallenge);
```

Also keep the existing `dodge-ai-best` write for backward compatibility (the old single-value key). The new `saveBest()` is additive, not replacing the old mechanism yet.

**4. Update bestTime to read from the new list** -- Change how `this.bestTime` is initialized in the constructor. After the migration call, read from the new list if available:
```javascript
const bests = loadBests();
if (bests.length > 0) {
  this.bestTime = bests[0].time;  // Top entry is the best
} else {
  this.bestTime = parseFloat(localStorage.getItem('dodge-ai-best') || '0');
}
```

This replaces the existing `this.bestTime = parseFloat(localStorage.getItem('dodge-ai-best') || '0');` line.

**5. Update updateStartScreen() to read from personal best list** -- The start screen `Best: Xs` display should read from the new list. Change the updateStartScreen() method:
```javascript
updateStartScreen() {
  const bests = loadBests();
  const best = bests.length > 0 ? bests[0].time : 0;
  const el = document.getElementById('start-best');
  el.textContent = best > 0 ? `Best: ${best.toFixed(1)}s` : '';
  // Daily button update (from Plan 01) stays as-is
  const dailyBtn = document.getElementById('btn-daily');
  const todayKey = 'dodge-ai-daily-' + getTodayUTC();
  const dailyBest = parseFloat(localStorage.getItem(todayKey) || '0');
  if (dailyBest > 0) {
    dailyBtn.textContent = `DAILY CHALLENGE (${dailyBest.toFixed(1)}s)`;
  } else {
    dailyBtn.textContent = 'DAILY CHALLENGE';
  }
}
```

Note: The `isNewBest` check in die() should also compare against the personal best list. Update the `isNewBest` determination in die():
```javascript
const bests = loadBests();
const currentBest = bests.length > 0 ? bests[0].time : 0;
const isNewBest = this.gameTime > currentBest;
if (isNewBest) {
  this.bestTime = this.gameTime;
  localStorage.setItem('dodge-ai-best', this.bestTime.toFixed(1));
}
```
This replaces `const isNewBest = this.gameTime > this.bestTime;`.
  </action>
  <verify>
1. Clear localStorage, open game, die -- `dodge-ai-bests` key appears in localStorage with one entry
2. Play multiple games -- list grows to max 5, sorted by time descending
3. Check that `dodge-ai-best` still gets written (backward compat)
4. Set `dodge-ai-best` to "42.3" manually in localStorage, remove `dodge-ai-bests`, refresh -- migration creates array with 42.3 entry dated "legacy"
5. Start screen shows correct best time from the new list
  </verify>
  <done>Personal best list stored as dodge-ai-bests JSON array in localStorage. Top 5 entries, sorted by time. Migration from dodge-ai-best on first load. Both new and old keys stay in sync. die() saves to personal best list after every death.</done>
</task>

<task type="auto">
  <name>Task 2: Display personal bests in stats modal and add daily badge to share card</name>
  <files>index.html</files>
  <action>
**1. Add CSS for the personal bests list** (in the style block):
```css
.bests-list {
  margin-top: 16px;
  text-align: left;
}

.bests-list h3 {
  color: #facc15;
  font-family: 'Courier New', monospace;
  font-size: 0.9rem;
  margin-bottom: 8px;
  letter-spacing: 1px;
}

.bests-list ol {
  list-style: none;
  padding: 0;
  margin: 0;
  font-family: 'Courier New', monospace;
  font-size: 0.85rem;
}

.bests-list li {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 6px 0;
  border-bottom: 1px solid rgba(255, 255, 255, 0.05);
  color: #ccc;
}

.bests-list li:last-child {
  border-bottom: none;
}

.bests-list .best-rank {
  color: #666;
  width: 24px;
  flex-shrink: 0;
}

.bests-list .best-time {
  color: #00f0ff;
  font-weight: bold;
  flex-shrink: 0;
}

.bests-list .best-date {
  color: #666;
  font-size: 0.8rem;
}

.bests-list .best-daily {
  color: #facc15;
  font-size: 0.7rem;
  margin-left: 4px;
}

.bests-list .bests-empty {
  color: #555;
  font-style: italic;
  padding: 8px 0;
}
```

**2. Update the stats modal onclick handler** (~line 2271) to include the personal bests section. After the existing stats-grid innerHTML assignment and BEFORE the modal show line, add:

```javascript
// Personal bests section
const bests = loadBests();
let bestsHTML = '<div class="bests-list"><h3>PERSONAL BESTS</h3>';
if (bests.length === 0) {
  bestsHTML += '<div class="bests-empty">No games played yet</div>';
} else {
  bestsHTML += '<ol>';
  bests.forEach((b, i) => {
    const dateStr = b.date === 'legacy' ? 'Pre-update' : new Date(b.date + 'T00:00:00').toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
    const dailyBadge = b.daily ? '<span class="best-daily">DAILY</span>' : '';
    bestsHTML += `<li><span class="best-rank">${i + 1}.</span><span class="best-time">${b.time.toFixed(1)}s</span><span class="best-date">${dateStr}${dailyBadge}</span></li>`;
  });
  bestsHTML += '</ol>';
}
bestsHTML += '</div>';
grid.insertAdjacentHTML('afterend', bestsHTML);
```

**Important:** The bests-list div is inserted after the stats-grid, so it appears below the existing 2x3 stat grid. But we need to clean it up on re-open so it doesn't duplicate. Before the innerHTML assignment, add:
```javascript
const existingBests = document.querySelector('.bests-list');
if (existingBests) existingBests.remove();
```

**3. Add DAILY CHALLENGE badge to share card** -- In the generateShareCard() method (~line 3296), add after the title "DODGE AI" is drawn (~after line 3320):
```javascript
if (this.isDailyChallenge) {
  ctx.font = 'bold 16px "Courier New", monospace';
  ctx.fillStyle = '#facc15';
  ctx.fillText(`DAILY CHALLENGE - ${getTodayUTC()}`, 60, 80);
}
```

This places a gold "DAILY CHALLENGE - YYYY-MM-DD" line just below the DODGE AI title on the share card, only when generated after a daily game.

**4. Update the share card stats row** to use the personal best list count as "Total Best":
No change needed -- the share card already shows Games Played and other stats. The personal best list is a stats modal feature, not a share card feature. Keep the share card as-is except for the daily badge.
  </action>
  <verify>
1. Open index.html, click STATS -- modal shows existing 2x3 stat grid PLUS "PERSONAL BESTS" section below
2. After playing a few games, STATS shows top 5 entries with time, date, and DAILY badge for daily games
3. The bests list is sorted by time (best first)
4. Legacy migrated entries show "Pre-update" as date
5. Re-opening STATS modal doesn't duplicate the bests section
6. Play a daily game, die, click Share -- the share card shows "DAILY CHALLENGE - YYYY-MM-DD" in gold below the title
7. Play a normal game, die, click Share -- no daily badge on share card
  </verify>
  <done>Stats modal displays personal bests list (top 5, with dates and daily badges). Share card shows gold DAILY CHALLENGE badge when generated after daily mode. Bests list cleans up on re-open. Legacy dates display as "Pre-update".</done>
</task>

</tasks>

<verification>
1. Fresh browser (clear localStorage) -- play 3 normal games and 2 daily games
2. STATS modal shows all 5 entries sorted by time, daily games marked with gold "DAILY" badge
3. Start screen shows best time from the top entry
4. Set localStorage `dodge-ai-best` to "99.9", remove `dodge-ai-bests`, refresh -- migration creates entry with "Pre-update" date
5. Share card after daily game has gold badge; after normal game, no badge
6. No console errors
7. Normal gameplay unaffected
</verification>

<success_criteria>
- Personal best list stored as dodge-ai-bests (JSON array, max 5, sorted by time desc)
- Each entry has time, date (UTC), and daily boolean flag
- Migration from dodge-ai-best preserves existing best time
- Stats modal shows personal bests section below existing stats grid
- Daily entries show gold "DAILY" badge in stats list
- Legacy entries show "Pre-update" as date
- Start screen best time reads from new list
- Share card shows DAILY CHALLENGE badge in daily mode
- No duplicate bests sections on modal re-open
- Backward compatibility: dodge-ai-best key still written
</success_criteria>

<output>
After completion, create `.planning/phases/04-retention/04-02-SUMMARY.md`
</output>
