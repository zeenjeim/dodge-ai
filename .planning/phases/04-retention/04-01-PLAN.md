---
phase: 04-retention
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [index.html]
autonomous: true

must_haves:
  truths:
    - "A DAILY CHALLENGE button appears on the start screen below PLAY"
    - "Clicking DAILY CHALLENGE starts a game where projectile spawns, aim rolls, and type selections are deterministic for today's date"
    - "Two players on the same UTC date get the same initial projectile sequence"
    - "Normal PLAY mode still uses Math.random() and behaves identically to before"
    - "Daily challenge HUD shows a DAILY CHALLENGE label in gold/amber"
    - "Game over screen in daily mode shows DAILY CHALLENGE context instead of generic quip"
    - "Cosmetic effects (particles, death explosion, background stars) remain truly random in daily mode"
  artifacts:
    - path: "index.html"
      provides: "Seeded PRNG (fnv1aHash + mulberry32), swappable this.rng(), daily challenge mode"
      contains: "fnv1aHash"
  key_links:
    - from: "fnv1aHash + getTodayUTC()"
      to: "mulberry32 PRNG"
      via: "getDailySeed() computes hash of UTC date string"
      pattern: "fnv1aHash.*dodge-ai-daily"
    - from: "Game.rng"
      to: "spawnWarnings, spawnProjectileFromWarning, spawnPowerup, spawnBoss, getPhaseDef"
      via: "this.rng() replaces Math.random() in gameplay methods only"
      pattern: "this\\.rng\\(\\)"
    - from: "btn-daily onclick"
      to: "Game.startDaily()"
      via: "Click handler sets seeded RNG and starts game"
      pattern: "btn-daily"
---

<objective>
Add seeded PRNG infrastructure and daily challenge mode to the game. Players can click DAILY CHALLENGE to play a date-seeded game where all players face the same projectile spawns for a given UTC day. Normal mode is unchanged.

Purpose: Give players a reason to return daily -- a shared challenge creates water-cooler moments ("how far did you get on today's daily?") and drives daily active users.
Output: index.html with fnv1aHash, mulberry32, swappable this.rng(), DAILY CHALLENGE button, daily-specific HUD label and game over screen.
</objective>

<execution_context>
@C:\Users\Zahi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Zahi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-retention/04-RESEARCH.md
@index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add seeded PRNG functions and swappable rng() method</name>
  <files>index.html</files>
  <action>
Add three standalone utility functions near the top of the script section (after the existing utility functions like `getDirectionName()` but before the class definitions). These are pure functions, not class methods:

1. **fnv1aHash(str)** -- FNV-1a string hash returning unsigned 32-bit integer:
```javascript
function fnv1aHash(str) {
  let h = 0x811c9dc5;
  for (let i = 0; i < str.length; i++) {
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 0x01000193);
  }
  return h >>> 0;
}
```

2. **mulberry32(seed)** -- seeded PRNG returning a function that produces floats [0, 1):
```javascript
function mulberry32(seed) {
  return function() {
    seed = (seed + 0x6D2B79F5) | 0;
    let t = Math.imul(seed ^ (seed >>> 15), seed | 1);
    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  };
}
```

3. **getTodayUTC()** -- returns "YYYY-MM-DD" string in UTC:
```javascript
function getTodayUTC() {
  const d = new Date();
  return `${d.getUTCFullYear()}-${String(d.getUTCMonth() + 1).padStart(2, '0')}-${String(d.getUTCDate()).padStart(2, '0')}`;
}
```

4. **getDailySeed()** -- returns today's daily challenge seed:
```javascript
function getDailySeed() {
  return fnv1aHash('dodge-ai-daily-' + getTodayUTC());
}
```

Then in the **Game class constructor** (around line 2134), add:
```javascript
this.rng = Math.random;
this.isDailyChallenge = false;
```

Then in the **Game.start() method** (around line 2325), add at the start of the method (after the DOM hiding lines but before resetting game state):
```javascript
if (!this.isDailyChallenge) {
  this.rng = Math.random;
}
```

Now **replace Math.random() with this.rng()** in the following gameplay-affecting methods ONLY. Do NOT touch cosmetic-only calls (particles in die(), background stars in idleLoop(), shockwave particles). The specific replacements:

**In spawnWarnings() and spawnProjectileFromWarning()** (~lines 2880-3050):
- ALL Math.random() calls in these methods become this.rng() -- these control edge selection, burst fan count, position jitter, homing chance, aim roll, type roll, counter-pattern firing, and zone targeting.

**In spawnPowerup()** (~lines 2728-2780):
- Math.random() calls for random spawn chance, type selection, position placement, and orbit angle become this.rng().

**In spawnBoss()** (~lines 3090-3115):
- Math.random() calls for edge selection and boss spawn position become this.rng().
- Do NOT change the boss defeat particle explosion Math.random() calls (~lines 3109-3111) -- those are cosmetic.

**In getPhaseDef()** (~line 2410+):
- If Math.random() is used for endgame cycle selection, replace with this.rng().

**In activatePowerup() / dash section** (~line 2864):
- The dash angle fallback Math.random() becomes this.rng() (affects gameplay -- dash direction).
- Do NOT change the dash particle trail Math.random() calls (~line 2866) -- those are cosmetic.

**In the Game constructor** (~line 2172) and **start()** (~line 2346):
- The powerupTimer initialization uses Math.random() -- replace with this.rng().

**CRITICAL: Leave Math.random() untouched in:**
- `die()` death particles (lines ~3142-3148) -- cosmetic
- `idleLoop()` background stars (lines ~2189-2192) -- cosmetic
- Particle class update (line ~1715, 1719) -- cosmetic
- Boss defeat explosion (lines ~3109-3111) -- cosmetic
- Shockwave particle spawns (~line 2553, 2566) -- cosmetic
- Powerup pickup particle burst (~line 2779) -- cosmetic
- Counter-pattern constructors with purely visual properties

Count: Approximately 50-55 gameplay Math.random() calls need replacing. ~15-20 cosmetic calls stay as Math.random().
  </action>
  <verify>
1. Open index.html in browser, click PLAY -- normal mode works identically (uses Math.random via this.rng)
2. Open browser console, run: `console.log(fnv1aHash('dodge-ai-daily-2026-02-19'))` -- returns a number
3. Run: `const rng = mulberry32(12345); console.log(rng(), rng(), rng())` -- returns 3 consistent floats
4. Search source for `this.rng()` -- should appear ~50 times in gameplay methods
5. Search source for `Math.random()` -- should still appear ~15-20 times in cosmetic-only contexts
  </verify>
  <done>Seeded PRNG infrastructure (fnv1aHash, mulberry32, getTodayUTC, getDailySeed) exists as standalone functions. Game class has swappable this.rng property defaulting to Math.random. All gameplay-affecting Math.random() calls replaced with this.rng(). Cosmetic Math.random() calls preserved.</done>
</task>

<task type="auto">
  <name>Task 2: Add daily challenge UI -- button, HUD label, game over, analytics</name>
  <files>index.html</files>
  <action>
**1. Add DAILY CHALLENGE button to start screen HTML** (after the PLAY button, ~line 783):
```html
<button class="menu-btn daily" id="btn-daily">DAILY CHALLENGE</button>
```

**2. Add CSS for the daily button and HUD label** (in the style block, near the existing `.menu-btn` styles):
```css
.menu-btn.daily {
  border-color: #facc15;
  color: #facc15;
}
.menu-btn.daily:hover {
  background: rgba(250, 204, 21, 0.15);
  border-color: #fde047;
  color: #fde047;
}

#daily-hud {
  position: fixed;
  top: 8px;
  left: 50%;
  transform: translateX(-50%);
  color: #facc15;
  font-family: 'Courier New', monospace;
  font-size: 14px;
  font-weight: bold;
  letter-spacing: 2px;
  z-index: 30;
  display: none;
  text-shadow: 0 0 10px rgba(250, 204, 21, 0.5);
}
```

**3. Add daily HUD element to HTML** (near the other HUD elements, before or after the brain-hud div):
```html
<div id="daily-hud">DAILY CHALLENGE</div>
```

**4. Add startDaily() method to Game class** (near the start() method):
```javascript
startDaily() {
  const seed = getDailySeed();
  this.rng = mulberry32(seed);
  this.isDailyChallenge = true;
  this.start();
}
```

**5. Wire up the daily button** in setupInput() (after the existing btn-start onclick, ~line 2256):
```javascript
document.getElementById('btn-daily').onclick = () => this.startDaily();
```

**6. Show/hide daily HUD** -- In start() method, after the existing DOM updates:
```javascript
document.getElementById('daily-hud').style.display = this.isDailyChallenge ? 'block' : 'none';
```

And hide it when returning to menu (in the btn-menu onclick handler, ~line 2259):
```javascript
document.getElementById('daily-hud').style.display = 'none';
```

**7. Update showGameOver() for daily mode** (~line 3255):
- When `this.isDailyChallenge` is true, replace the phase quip with a daily challenge quip:
```javascript
if (this.isDailyChallenge) {
  document.getElementById('go-phase').textContent = `Daily Challenge - ${getTodayUTC()}`;
  document.getElementById('go-phase').style.color = '#facc15';
} else {
  document.getElementById('go-phase').textContent = phaseQuips[Math.min(this.phase, 5)];
  document.getElementById('go-phase').style.color = '';
}
```

**8. Update die() analytics for daily mode** (~line 3131):
When `this.isDailyChallenge` is true, fire a different analytics event:
```javascript
if (this.isDailyChallenge) {
  trackEvent('daily-death', `Daily ${getTodayUTC()}: ${this.gameTime.toFixed(1)}s Phase ${this.phase + 1}`);
} else {
  trackEvent(`death-phase-${this.phase + 1}`, `Died at ${this.gameTime.toFixed(1)}s in Phase ${this.phase + 1}: ${PHASE_DEFS[Math.min(this.phase, PHASE_DEFS.length - 1)].name}`);
}
```

**9. Reset isDailyChallenge on normal play** -- In start() method, ensure that if the game is starting from a non-daily entry (btn-start or btn-retry), isDailyChallenge is properly false. The btn-start already calls this.start() directly (not startDaily()), and the reset at the top of start() sets `this.rng = Math.random` only when `!this.isDailyChallenge`. Add before the rng reset in start():

Actually, to keep it clean: in the btn-retry onclick handler, add `this.isDailyChallenge = false;` UNLESS we want retries to replay the daily. **Decision: retries should replay the same mode.** So btn-retry should check: if daily mode, call startDaily() instead of start(). Update the retry handler (~line 2257):
```javascript
document.getElementById('btn-retry').onclick = () => {
  if (this.isDailyChallenge) {
    this.startDaily();
  } else {
    this.start();
  }
};
```

**10. Show daily best time on the daily button** -- Update updateStartScreen() to show today's daily best on the button if one exists. Store last daily play date and best in localStorage:
- In die(), after saving totalGames, add:
```javascript
if (this.isDailyChallenge) {
  const todayKey = 'dodge-ai-daily-' + getTodayUTC();
  const prevDailyBest = parseFloat(localStorage.getItem(todayKey) || '0');
  if (this.gameTime > prevDailyBest) {
    localStorage.setItem(todayKey, this.gameTime.toFixed(1));
  }
}
```

- In updateStartScreen(), update the daily button text:
```javascript
const dailyBtn = document.getElementById('btn-daily');
const todayKey = 'dodge-ai-daily-' + getTodayUTC();
const dailyBest = parseFloat(localStorage.getItem(todayKey) || '0');
if (dailyBest > 0) {
  dailyBtn.textContent = `DAILY CHALLENGE (${dailyBest.toFixed(1)}s)`;
} else {
  dailyBtn.textContent = 'DAILY CHALLENGE';
}
```

**Important:** Unlimited attempts. Players can retry the daily as many times as they want. Best time is tracked per day using `dodge-ai-daily-YYYY-MM-DD` localStorage keys.
  </action>
  <verify>
1. Open index.html -- start screen shows DAILY CHALLENGE button in gold/amber below PLAY
2. Click DAILY CHALLENGE -- game starts, "DAILY CHALLENGE" label appears at top center in gold
3. Die -- game over screen shows "Daily Challenge - YYYY-MM-DD" instead of phase quip
4. Click Retry -- daily mode restarts (same seeded challenge)
5. Click Menu, then PLAY -- normal mode starts, no daily HUD, phase quip on death
6. Click Menu, check DAILY CHALLENGE button -- shows today's best if one exists
7. Refresh page entirely -- daily best for today persists
  </verify>
  <done>DAILY CHALLENGE button on start screen with gold accent. Daily mode uses seeded RNG via startDaily(). HUD shows daily label. Game over shows daily context. Retry preserves mode. Daily best tracked per-day in localStorage. Analytics fires daily-specific events.</done>
</task>

</tasks>

<verification>
1. Open index.html -- start screen has PLAY and DAILY CHALLENGE buttons
2. Click PLAY -- normal game, no daily HUD, random projectile patterns, phase quip on death
3. Click DAILY CHALLENGE -- daily HUD visible, game plays, game over shows "Daily Challenge" context
4. Refresh and click DAILY CHALLENGE again -- same initial projectile sequence as before (deterministic)
5. Console: no errors related to rng, fnv1aHash, or mulberry32
6. The daily button shows today's best time after first daily death
7. Normal mode is completely unaffected by the PRNG changes
</verification>

<success_criteria>
- fnv1aHash, mulberry32, getTodayUTC, getDailySeed standalone functions exist
- Game.rng defaults to Math.random, switchable to seeded PRNG for daily mode
- ~50 gameplay Math.random() calls replaced with this.rng()
- ~15-20 cosmetic Math.random() calls preserved
- DAILY CHALLENGE button on start screen with gold/amber accent
- Daily HUD label visible during daily games
- Game over screen shows daily context in daily mode
- Retry preserves current mode (daily or normal)
- Daily best time tracked per UTC date in localStorage
- Analytics events differentiate daily vs normal deaths
- Normal mode completely unaffected
- RET-01 requirement satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/04-retention/04-01-SUMMARY.md`
</output>
