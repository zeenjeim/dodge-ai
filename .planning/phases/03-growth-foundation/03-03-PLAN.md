---
phase: 03-growth-foundation
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified: [index.html]
autonomous: true
user_setup:
  - service: goatcounter
    why: "Privacy-first analytics (free, no cookies, built-in dashboard)"
    env_vars: []
    dashboard_config:
      - task: "Create GoatCounter account and site"
        location: "https://www.goatcounter.com/signup -- create site code (e.g. dodgeai.goatcounter.com)"

must_haves:
  truths:
    - "GoatCounter script tag loads in the page (or gracefully no-ops if account not set up)"
    - "Game start fires a game-start event"
    - "Death fires a death-phase-N event with phase number"
    - "Milestones fire events: first game, reached new phase, share card generated"
    - "Page load fires page-load event for pre-play drop-off measurement"
    - "Per-session game count is tracked via session-games-N events"
    - "All analytics calls are fire-and-forget -- failures never affect gameplay"
  artifacts:
    - path: "index.html"
      provides: "GoatCounter script tag, trackEvent() helper, analytics hooks in start/die/share/milestone"
      contains: "goatcounter"
  key_links:
    - from: "trackEvent() helper"
      to: "window.goatcounter.count()"
      via: "Guarded call with existence check"
      pattern: "window\\.goatcounter.*\\.count"
    - from: "start() method"
      to: "trackEvent('game-start')"
      via: "Called at start of each game"
      pattern: "trackEvent.*game-start"
    - from: "die() method"
      to: "trackEvent('death-phase-')"
      via: "Called on player death with phase number"
      pattern: "trackEvent.*death-phase"
    - from: "share() method"
      to: "trackEvent('share-')"
      via: "Called when share card is generated"
      pattern: "trackEvent.*share"
---

<objective>
Integrate GoatCounter analytics into the game, tracking game starts, deaths (with phase and survival time), milestones (first game, new phases, share actions), page load for pre-play drop-off, and per-session game counts.

Purpose: Measure player engagement without cookies or consent banners. Data enables understanding where players drop off (never start, die early, leave after N games) and which features get used (share card, power-ups, late phases).
Output: index.html with GoatCounter script and analytics event hooks throughout game lifecycle.
</objective>

<execution_context>
@C:\Users\Zahi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Zahi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-growth-foundation/03-RESEARCH.md
@.planning/phases/03-growth-foundation/03-02-SUMMARY.md
@index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add GoatCounter script and trackEvent helper</name>
  <files>index.html</files>
  <action>
Two additions to index.html:

**1. Add GoatCounter script tag** at the end of `<body>`, AFTER the closing `</script>` of the game code and BEFORE `</body>`. Use a placeholder site code that's easy to swap:

```html
<!-- Analytics: GoatCounter (privacy-first, no cookies) -->
<script data-goatcounter="https://DODGEAI.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
```

The `DODGEAI` placeholder gets replaced when the user creates their GoatCounter account. The script loads async and the game works fine without it.

**2. Add trackEvent() helper function** near the top of the `<script>` block (after the utility functions like `decayWeight` and `getDirectionName`, before the class definitions). This is a standalone utility, not a class method:

```javascript
// Analytics: fire-and-forget event tracking via GoatCounter
// All calls are guarded -- never throws, never blocks gameplay
function trackEvent(name, title) {
  try {
    if (window.goatcounter && window.goatcounter.count) {
      window.goatcounter.count({
        path: name,
        title: title || name,
        event: true,
      });
    }
  } catch (e) {
    // Silently ignore -- analytics must never affect gameplay
  }
}
```

Key: Wrap in try/catch AND check existence. Double safety per research pitfall #3 (async loading race condition). The function is a no-op if GoatCounter hasn't loaded yet or if the script fails to load entirely.
  </action>
  <verify>
- Open index.html in browser
- In console, type `trackEvent` -- should be a defined function
- Type `trackEvent('test-event', 'Test')` -- should not throw (GoatCounter won't be set up yet, but the guard prevents errors)
- Game loads and plays normally
- No console errors related to GoatCounter (script 404 is expected until account created)
  </verify>
  <done>GoatCounter script tag present in HTML. trackEvent() helper is available globally and safely no-ops when GoatCounter is not loaded.</done>
</task>

<task type="auto">
  <name>Task 2: Wire analytics events into game lifecycle</name>
  <files>index.html</files>
  <action>
Add trackEvent() calls at key points throughout the Game class. These are single-line additions -- do not restructure existing code. All event names use kebab-case per the naming convention in RESEARCH.md.

**1. Page load + pre-play drop-off tracking** -- Add a session tracking variable and page load event OUTSIDE the Game class, near the bottom of the script (before `const game = new Game()`):

```javascript
// Analytics: session tracking
let _sessionGamesPlayed = 0;
let _gameEverStarted = false;

// Track page load (fires when GoatCounter loads, or on next available moment)
// Compare page-load count vs game-start count in dashboard to get pre-play drop-off
function _initAnalytics() {
  trackEvent('page-load', 'Page Loaded');
}
// GoatCounter loads async; poll briefly to fire page-load event
(function() {
  let attempts = 0;
  const interval = setInterval(() => {
    attempts++;
    if (window.goatcounter && window.goatcounter.count) {
      _initAnalytics();
      clearInterval(interval);
    } else if (attempts > 20) {
      clearInterval(interval); // Give up after ~10 seconds
    }
  }, 500);
})();
```

**2. Game start event** -- Add at the END of the `start()` method (after `this.brain.reset()` and the existing code, near the end of the method):

```javascript
// Analytics
_gameEverStarted = true;
_sessionGamesPlayed++;
trackEvent('game-start', `Game ${_sessionGamesPlayed} started`);
if (_sessionGamesPlayed === 1) {
  trackEvent('milestone-first-game', 'First game this session');
}
```

**3. Death event** -- Add at the START of the `die()` method (right after the opening brace, before the existing code):

```javascript
// Analytics: death event with phase info
trackEvent(
  `death-phase-${this.phase + 1}`,
  `Died at ${this.gameTime.toFixed(1)}s in Phase ${this.phase + 1}: ${PHASE_DEFS[Math.min(this.phase, PHASE_DEFS.length - 1)].name}`
);
```

**4. Phase milestone event** -- In the phase advancement section (inside the `update()` method where `this.phase !== this._lastAnnouncedPhase` is checked), add INSIDE that if-block, alongside the existing `this._lastAnnouncedPhase = this.phase` and `this.announcePhase()`:

```javascript
// Analytics: phase milestone
trackEvent(`milestone-phase-${this.phase + 1}`, `Reached Phase ${this.phase + 1}: ${PHASE_DEFS[this.phase].name}`);
```

**5. Share event** -- Add inside the share() method, right at the top (first line after the opening brace), BEFORE generateShareCard():

```javascript
trackEvent('share-card-generated', 'Share Card Generated');
```

Also add specific share method tracking inside the toBlob callback:
- After successful navigator.share: `trackEvent('share-native', 'Shared via native dialog');`
- After download fallback: `trackEvent('share-download', 'Shared via image download');`

**6. Per-session game count on unload** -- Add right after the `_initAnalytics` polling block:

```javascript
// Track session depth on page unload (best-effort)
window.addEventListener('beforeunload', () => {
  if (_sessionGamesPlayed > 0) {
    trackEvent(`session-games-${Math.min(_sessionGamesPlayed, 10)}`,
      `Session ended after ${_sessionGamesPlayed} games`);
  }
});
```

Cap at 10 to avoid unbounded event names. Sessions with 10+ games all go to `session-games-10`.

**Event naming summary:**
| Event | When | Dashboard insight |
|-------|------|-------------------|
| `page-load` | Script loads | Total visitors |
| `game-start` | Each game begins | Active players |
| `milestone-first-game` | First game in session | Conversion rate |
| `death-phase-1` through `death-phase-6` | Player dies | Difficulty curve |
| `milestone-phase-2` through `milestone-phase-6` | Enters new phase | Progression funnel |
| `share-card-generated` | Share button clicked | Share intent |
| `share-native` | Native share succeeded | Share completion (mobile) |
| `share-download` | Image downloaded | Share completion (desktop) |
| `session-games-1` through `session-games-10` | Page unload | Session depth/stickiness |

**Critical rule:** Every trackEvent call is a single line addition. Do NOT wrap game logic in analytics conditionals. Do NOT add error handling that could affect game flow. Analytics is purely observational.
  </action>
  <verify>
1. Open index.html in browser, open DevTools console
2. Start a game -- check no console errors
3. Die -- check no console errors
4. Click Share -- check no console errors
5. In console, verify `_sessionGamesPlayed` equals the number of games played
6. In console, type `trackEvent` -- should be defined
7. Game plays identically to before all analytics additions
8. Search in source for each event name to confirm all 6 hook points are present:
   - `page-load`, `game-start`, `milestone-first-game`, `death-phase-`, `milestone-phase-`, `share-card-generated`, `share-native`, `share-download`, `session-games-`
  </verify>
  <done>Analytics events fire at all key lifecycle points (page load, game start, death, phase advancement, share). All calls are fire-and-forget via guarded trackEvent(). beforeunload tracks session depth. Requirement GROW-05 satisfied with all three drop-off layers: pre-play (page-load vs game-start), per-session (session-games-N), return rate (GoatCounter's built-in unique visitor tracking).</done>
</task>

</tasks>

<verification>
1. Game loads without console errors (GoatCounter 404 is expected until account setup)
2. Play through multiple games -- no performance impact, no errors
3. `trackEvent` function exists and safely no-ops
4. `_sessionGamesPlayed` counter increments correctly
5. All event hook points present in source code
6. When GoatCounter account is created and site code updated: events appear in GoatCounter dashboard
7. Game functionality completely unaffected by analytics code
</verification>

<success_criteria>
- GoatCounter script tag in HTML (with placeholder site code)
- trackEvent() helper is guarded and fire-and-forget
- Events fire at: page load, game start, death (with phase), phase milestone, share (with method), session unload
- Three-layer drop-off measurable: pre-play, per-session, return rate
- Zero impact on game performance or functionality
- GROW-05 (Analytics integration tracking sessions, retention, drop-off) complete
</success_criteria>

<output>
After completion, create `.planning/phases/03-growth-foundation/03-03-SUMMARY.md`
</output>
