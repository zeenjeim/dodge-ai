---
phase: 03-growth-foundation
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified: [index.html]
autonomous: true

must_haves:
  truths:
    - "Game over screen has a Share button that generates a 1200x630 PNG image with game stats and AI commentary"
    - "On mobile (navigator.share supported), Share opens native OS share dialog with the image file"
    - "On desktop (no navigator.share), Share triggers a PNG download of the card"
    - "Clipboard text share still works as secondary option alongside the visual card"
    - "Share card matches the game's visual style (dark bg, cyan, purple, red colors)"
  artifacts:
    - path: "index.html"
      provides: "generateShareCard() function, updated share() with image flow"
      contains: "generateShareCard"
  key_links:
    - from: "share() method"
      to: "generateShareCard()"
      via: "Called on Share button click"
      pattern: "generateShareCard"
    - from: "generateShareCard()"
      to: "canvas.toBlob()"
      via: "Converts drawn card to PNG blob"
      pattern: "toBlob"
    - from: "share()"
      to: "navigator.share()"
      via: "Native share with File object (mobile)"
      pattern: "navigator\\.share"
    - from: "share()"
      to: "URL.createObjectURL"
      via: "Download fallback (desktop)"
      pattern: "createObjectURL"
---

<objective>
Replace the existing text-only share function with a visual share card system. When the player taps Share on the game over screen, generate a 1200x630 PNG canvas card showing survival time, phase reached, dodge stats, and AI commentary, then share via native OS dialog (mobile) or download (desktop).

Purpose: A visual share card with AI commentary is far more shareable than plain text. The AI's trash-talk commentary ("You dodge left 67% of the time. Real original.") is the viral hook -- it makes people want to prove the AI wrong.
Output: Updated share() method with generateShareCard(), native share + download fallback, clipboard text as secondary.
</objective>

<execution_context>
@C:\Users\Zahi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Zahi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-growth-foundation/03-RESEARCH.md
@index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement generateShareCard() and update share flow</name>
  <files>index.html</files>
  <action>
Replace the existing `share()` method (currently at ~line 3117-3133 in index.html) and add a new `generateShareCard()` method to the Game class.

**1. Add `generateShareCard()` method** to the Game class (before or after the existing share method):

```javascript
generateShareCard() {
  const card = document.createElement('canvas');
  card.width = 1200;
  card.height = 630;
  const ctx = card.getContext('2d');

  // Background
  ctx.fillStyle = '#06060f';
  ctx.fillRect(0, 0, 1200, 630);

  // Subtle grid pattern (matches game aesthetic)
  ctx.strokeStyle = 'rgba(0, 240, 255, 0.03)';
  ctx.lineWidth = 1;
  for (let x = 0; x < 1200; x += 40) {
    ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, 630); ctx.stroke();
  }
  for (let y = 0; y < 630; y += 40) {
    ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(1200, y); ctx.stroke();
  }

  // Title: DODGE AI
  ctx.font = 'bold 42px "Courier New", monospace';
  ctx.fillStyle = '#00f0ff';
  ctx.textBaseline = 'top';
  ctx.fillText('DODGE AI', 60, 40);

  // AI confidence badge (top right)
  const confidence = this.brain.getConfidence();
  ctx.font = '20px "Courier New", monospace';
  ctx.fillStyle = '#ff3355';
  ctx.textAlign = 'right';
  ctx.fillText(`AI Confidence: ${confidence}%`, 1140, 48);
  ctx.textAlign = 'left';

  // Survival time (hero stat)
  ctx.font = 'bold 100px "Courier New", monospace';
  ctx.fillStyle = '#ffffff';
  ctx.fillText(`${this.gameTime.toFixed(1)}s`, 60, 110);

  // Phase reached
  const phaseName = PHASE_DEFS[Math.min(this.phase, PHASE_DEFS.length - 1)].name;
  ctx.font = 'bold 26px "Courier New", monospace';
  ctx.fillStyle = '#8b5cf6';
  ctx.fillText(`Phase ${this.phase + 1}: ${phaseName}`, 60, 230);

  // Divider line
  ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(60, 275);
  ctx.lineTo(1140, 275);
  ctx.stroke();

  // Stats row
  ctx.font = '20px "Courier New", monospace';
  ctx.fillStyle = '#888888';
  const closestStr = this.closestCall === Infinity ? '0px' : `${Math.round(this.closestCall)}px`;
  ctx.fillText(`Dodged: ${this.dodgedCount}`, 60, 300);
  ctx.fillText(`Closest Call: ${closestStr}`, 360, 300);
  ctx.fillText(`Games Played: ${this.totalGames}`, 700, 300);

  // AI commentary (the viral hook)
  const aiText = document.getElementById('go-ai-learned').textContent;
  ctx.font = 'italic 20px "Courier New", monospace';
  ctx.fillStyle = '#ff3355';

  // Word-wrap AI commentary to fit card width
  const maxWidth = 1080;
  const words = aiText.split(' ');
  let line = '';
  let y = 360;
  const lineHeight = 28;
  for (const word of words) {
    const testLine = line + (line ? ' ' : '') + word;
    if (ctx.measureText(testLine).width > maxWidth) {
      ctx.fillText(line, 60, y);
      line = word;
      y += lineHeight;
      if (y > 480) break; // Don't overflow
    } else {
      line = testLine;
    }
  }
  if (line && y <= 480) ctx.fillText(line, 60, y);

  // CTA at bottom
  ctx.font = '18px "Courier New", monospace';
  ctx.fillStyle = '#444444';
  ctx.fillText('Think you can survive longer?', 60, 580);

  return card;
}
```

**2. Replace the existing `share()` method** with the new version that generates a visual card:

```javascript
share() {
  // Generate visual card
  const card = this.generateShareCard();

  // Also prepare text for clipboard (secondary share option)
  const phase = PHASE_DEFS[this.phase].name;
  const emoji = this.phase >= 4 ? String.fromCodePoint(0x1F525) : this.phase >= 2 ? String.fromCodePoint(0x26A1) : String.fromCodePoint(0x1F3AF);
  const text = [
    `${emoji} DODGE AI \u2014 ${this.gameTime.toFixed(1)}s`,
    `Phase ${this.phase + 1}: ${phase}`,
    `Dodged: ${this.dodgedCount}`,
    this.bossesDefeated > 0 ? `Bosses demolished: ${this.bossesDefeated}` : '',
    `The AI thinks it knows me (${this.brain.getConfidence()}% confident)`,
    '',
    'Think you can last longer?',
  ].filter(Boolean).join('\n');

  // Convert card to blob and share
  card.toBlob(async (blob) => {
    if (!blob) {
      // Fallback to clipboard text if blob generation fails
      if (navigator.clipboard) navigator.clipboard.writeText(text).catch(() => {});
      return;
    }

    const file = new File([blob], 'dodge-ai-score.png', { type: 'image/png' });

    // Try native share (mobile-first)
    if (navigator.canShare && navigator.canShare({ files: [file] })) {
      try {
        await navigator.share({
          files: [file],
          title: 'DODGE AI',
          text: text
        });
        return;
      } catch (e) {
        if (e.name === 'AbortError') return; // User cancelled
      }
    }

    // Fallback: download the image
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'dodge-ai-score.png';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    // Also copy text to clipboard as secondary
    if (navigator.clipboard) navigator.clipboard.writeText(text).catch(() => {});
  }, 'image/png');
}
```

Key implementation notes:
- Use `toBlob` (NOT toDataURL) -- async, faster, returns binary Blob per research anti-patterns
- Only generate card when Share is clicked (NOT on every game over) per research anti-patterns
- AI commentary text comes from `#go-ai-learned` element which is already populated by showGameOver()
- Word-wrap the AI commentary since it can be long
- Colors match game palette: #06060f bg, #00f0ff cyan, #8b5cf6 purple, #ff3355 red, #ffffff white
- Font is 'Courier New', monospace (same as game)
- navigator.canShare check before navigator.share per research pitfall #2
- Clipboard text kept as fallback/secondary
  </action>
  <verify>
1. Open index.html in browser, play until death
2. On game over screen, click SHARE
3. On desktop: should trigger a PNG download named "dodge-ai-score.png"
4. Open the downloaded PNG: should be 1200x630 with dark background, game title, survival time, phase, stats, and AI commentary in red
5. Verify clipboard also has text share content
6. No console errors
  </verify>
  <done>Share button generates a 1200x630 visual card with stats and AI commentary. Mobile uses native share dialog with image file. Desktop downloads the PNG. Clipboard text always available as secondary. Requirement GROW-01 satisfied.</done>
</task>

</tasks>

<verification>
1. Play a game until death -- game over screen shows normally
2. Click SHARE -- image downloads on desktop (or native share on mobile)
3. Downloaded image is 1200x630 with correct content: title, time, phase, stats, AI commentary
4. Image colors match game aesthetic (dark bg, cyan title, purple phase, red AI text)
5. AI commentary text is the same as what shows on game over screen
6. No console errors
7. Existing game functionality unaffected
</verification>

<success_criteria>
- generateShareCard() creates a 1200x630 canvas with game stats and AI commentary
- share() uses toBlob (not toDataURL), navigator.share for mobile, download for desktop
- Visual card matches game's dark theme and color palette
- GROW-01 (Canvas-generated visual share card with stats, phase, AI commentary) complete
</success_criteria>

<output>
After completion, create `.planning/phases/03-growth-foundation/03-02-SUMMARY.md`
</output>
