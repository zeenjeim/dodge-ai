---
phase: 05-new-mechanics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [index.html]
autonomous: true

must_haves:
  truths:
    - "Spiral projectiles appear from Phase 3 (PREDICTING) onward with a corkscrew movement pattern"
    - "Cluster/nova projectiles appear from Phase 4 (TIMING) onward, traveling straight then exploding into a 6-bullet ring"
    - "Mine projectiles appear from Phase 5 (HUNTING) onward, traveling slowly then dwelling and detonating toward the player"
    - "Each new type has a distinct color and shape distinguishable from existing projectile types"
    - "AI controls new type frequency through existing threat level modifiers in getPhaseDef()"
    - "Daily challenge determinism is preserved -- all new type rolls use this.rng()"
  artifacts:
    - path: "index.html"
      provides: "3 new projectile types integrated into spawn pipeline"
      contains: "spiralChance"
  key_links:
    - from: "PHASE_DEFS"
      to: "spawnProjectileFromWarning"
      via: "spiralChance, clusterChance, mineChance fields"
      pattern: "def\\.spiralChance"
    - from: "spawnProjectileFromWarning"
      to: "Projectile constructor"
      via: "type: 'spiral' | 'cluster' | 'mine'"
      pattern: "type.*spiral"
    - from: "Projectile.update()"
      to: "movement branches"
      via: "this.type === 'spiral' | 'cluster' | 'mine'"
      pattern: "this\\.type === 'spiral'"
---

<objective>
Add 3 new projectile types (spiral, cluster, mine) to the existing spawn pipeline.

Purpose: Expand visual and mechanical variety of the bullet patterns players must dodge, creating new readable patterns (spiral lanes), semi-chaotic bursts (cluster explosions), and area denial (mines). This directly fulfills MECH-01.

Output: index.html with 9 total projectile types (existing 6 + 3 new), each with distinct movement, visuals, and phase-gated spawn chances.
</objective>

<execution_context>
@C:\Users\Zahi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Zahi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-new-mechanics/05-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add spiral, cluster, and mine type fields to PHASE_DEFS and type roll in spawnProjectileFromWarning</name>
  <files>index.html</files>
  <action>
1. Add new chance fields to each PHASE_DEFS entry (lines ~1101-1114). New fields per phase:
   - SCANNING (Phase 0): spiralChance: 0, clusterChance: 0, mineChance: 0
   - TARGETING (Phase 1): spiralChance: 0, clusterChance: 0, mineChance: 0
   - PREDICTING (Phase 2): spiralChance: 0.1, clusterChance: 0, mineChance: 0
   - TIMING (Phase 3): spiralChance: 0.15, clusterChance: 0.1, mineChance: 0
   - HUNTING (Phase 4): spiralChance: 0.15, clusterChance: 0.15, mineChance: 0.1
   - EVOLVED (Phase 5): spiralChance: 0.2, clusterChance: 0.2, mineChance: 0.15

2. Also update EVOLVED_BASE (line ~1117) so it picks up the new fields.

3. In spawnProjectileFromWarning() (line ~3255-3261), extend the type roll chain AFTER the existing accel check:
   ```
   else if (typeRoll < def.splitterChance + def.bouncerChance + def.waveChance + def.accelChance + def.spiralChance) type = 'spiral';
   else if (typeRoll < def.splitterChance + def.bouncerChance + def.waveChance + def.accelChance + def.spiralChance + def.clusterChance) type = 'cluster';
   else if (typeRoll < def.splitterChance + def.bouncerChance + def.waveChance + def.accelChance + def.spiralChance + def.clusterChance + def.mineChance) type = 'mine';
   ```

4. Add color assignments for new types (after line ~3268):
   ```
   else if (type === 'spiral') color = '#00ffaa';  // mint green
   else if (type === 'cluster') color = '#ff8800';  // amber
   else if (type === 'mine') color = '#ff0066';     // hot pink
   ```

5. For cluster and mine types, set initial properties in the Projectile constructor opts or right after creation:
   - Cluster: set `fuseTime` property (0.8 + this.rng() * 0.4) on the projectile AFTER push. Use this.rng() for daily determinism.
   - Mine: set `travelTime = 0.5` and `dwellTime = 2.0 + this.rng() * 1.0` properties similarly.

6. Cap total projectile count at 80 for performance. In the spawn section before creating warning, add early return: `if (this.projectiles.length >= 80) return;`

All new rolls MUST use this.rng() (not Math.random()) to preserve daily challenge determinism.
  </action>
  <verify>
Open index.html in browser. Play through to Phase 3 (PREDICTING, ~40s). Observe that some projectiles now spawn as spiral/cluster/mine types with their distinct colors. Verify in console: `_game.projectiles.filter(p => p.type === 'spiral').length` returns > 0 after reaching Phase 3.
  </verify>
  <done>PHASE_DEFS contain spiralChance/clusterChance/mineChance fields, spawnProjectileFromWarning rolls for new types, projectile cap at 80.</done>
</task>

<task type="auto">
  <name>Task 2: Add spiral, cluster, and mine movement and rendering in Projectile class</name>
  <files>index.html</files>
  <action>
1. In Projectile constructor (~line 1804-1823), add default properties for new types:
   ```javascript
   this.spiralAngle = 0;
   this.spiralSpeed = opts.spiralSpeed || 6;   // radians/sec
   this.spiralRadius = opts.spiralRadius || 25; // pixel amplitude
   this.fuseTime = opts.fuseTime || 1.0;
   this.hasExploded = false;
   this.travelTime = opts.travelTime || 0.5;
   this.dwellTime = opts.dwellTime || 2.5;
   this.hasDetonated = false;
   ```

2. In Projectile.update() (~line 1825), add movement branches BEFORE the default `else` block (after the accel branch at ~1858):

   **Spiral** (after accel, before else):
   ```javascript
   else if (this.type === 'spiral') {
     this.spiralAngle += this.spiralSpeed * dt;
     const baseAngle = Math.atan2(this.baseVy, this.baseVx);
     const perpX = -Math.sin(baseAngle);
     const perpY = Math.cos(baseAngle);
     const orbit = Math.sin(this.spiralAngle) * this.spiralRadius;
     this.x += this.baseVx * dt * 60 * speed + perpX * orbit * dt * 4;
     this.y += this.baseVy * dt * 60 * speed + perpY * orbit * dt * 4;
   }
   ```

   **Cluster** (returns children array when fuse expires -- follow splitter pattern):
   ```javascript
   else if (this.type === 'cluster') {
     this.x += this.vx * dt * 60 * speed;
     this.y += this.vy * dt * 60 * speed;
     // Explosion is handled in checkCluster() below
   }
   ```

   **Mine** (three phases: travel, dwell, detonate):
   ```javascript
   else if (this.type === 'mine') {
     if (this.age < this.travelTime) {
       this.x += this.vx * dt * 60 * speed * 0.3;
       this.y += this.vy * dt * 60 * speed * 0.3;
     }
     // dwell: do nothing (sits in place)
     // detonation is handled in checkMineDetonate() below
   }
   ```

3. Add checkCluster() method to Projectile (alongside checkSplit, ~line 1870):
   ```javascript
   checkCluster() {
     if (this.type !== 'cluster' || this.hasExploded) return null;
     if (this.age > this.fuseTime) {
       this.hasExploded = true;
       const children = [];
       const count = 6;
       const childSpeed = Math.sqrt(this.vx * this.vx + this.vy * this.vy) * 0.8;
       for (let i = 0; i < count; i++) {
         const a = (i / count) * Math.PI * 2;
         children.push(new Projectile(this.x, this.y,
           Math.cos(a) * childSpeed, Math.sin(a) * childSpeed,
           '#ff8800', { radius: 3, type: 'normal', splitChildren: true }
         ));
       }
       return children;
     }
     return null;
   }
   ```

4. Add checkMineDetonate() method to Projectile (alongside checkCluster):
   ```javascript
   checkMineDetonate(playerX, playerY) {
     if (this.type !== 'mine' || this.hasDetonated) return null;
     if (this.age > this.travelTime + this.dwellTime) {
       this.hasDetonated = true;
       const children = [];
       const count = 4;
       const dx = playerX - this.x;
       const dy = playerY - this.y;
       const dist = Math.sqrt(dx * dx + dy * dy) || 1;
       const baseSpeed = 5;
       const spread = 0.3;
       for (let i = 0; i < count; i++) {
         const angle = Math.atan2(dy, dx) + (i - 1.5) * spread;
         children.push(new Projectile(this.x, this.y,
           Math.cos(angle) * baseSpeed, Math.sin(angle) * baseSpeed,
           '#ff0066', { radius: 3, type: 'normal', splitChildren: true }
         ));
       }
       return children;
     }
     return null;
   }
   ```

5. In Game.update() where projectiles are iterated (~line 2764), alongside the existing checkSplit and checkBounce calls, add:
   ```javascript
   const clusterChildren = p.checkCluster();
   if (clusterChildren) { newProjectiles.push(...clusterChildren); }
   const mineChildren = p.checkMineDetonate(this.player.x, this.player.y);
   if (mineChildren) { newProjectiles.push(...mineChildren); }
   ```
   Also mark exploded clusters and detonated mines for removal (same as splitters that have split -- check `p.hasExploded || p.hasDetonated`).

6. In drawShape() function (~line 1686), add new shape cases:
   - 'spiralShape': 3-arm swirl glyph (3 small arcs radiating from center)
   - 'clusterShape': circle with expanding ring (circle + outer ring)
   - 'mineShape': octagon with crosshair (8-sided polygon + cross lines)

7. In Projectile.draw() (~line 1904), add shape selection for new types:
   - spiral: use 'spiralShape', rotate based on spiralAngle
   - cluster: use 'clusterShape', pulse slightly as age approaches fuseTime (scale up slightly in last 0.2s)
   - mine: use 'mineShape', during dwell phase add a pulsing glow (opacity oscillation to telegraph danger)

IMPORTANT: Mine visual during dwell phase should pulse with increasing intensity (opacity 0.3 + sin(age * 4) * 0.3) to telegraph the upcoming detonation. This satisfies the "visual preview telegraphing" locked decision.
  </action>
  <verify>
Open index.html in browser. Play to Phase 3+. Verify:
1. Spiral projectiles (mint green) oscillate in a corkscrew pattern along their trajectory
2. Cluster projectiles (amber) travel straight then burst into a 6-bullet ring
3. Mine projectiles (hot pink) travel slowly, stop and pulse, then detonate toward the player
4. Exploded clusters and detonated mines are removed from the projectile array (no ghost entities)
5. Console check: `_game.projectiles.length` never exceeds 80
  </verify>
  <done>All 3 new projectile types have distinct movement patterns, visual shapes, colors, and explosion/detonation mechanics. Spiral creates readable lanes, cluster creates semi-chaotic bursts, mine creates area denial. Total: 9 projectile types.</done>
</task>

</tasks>

<verification>
- Open browser, play game from start to Phase 5+ (HUNTING, ~80s)
- Observe new projectile types appearing at correct phases (spiral from Phase 3, cluster from Phase 4, mine from Phase 5)
- Verify each type has distinct color (mint/amber/hot pink) and movement pattern
- Verify cluster explosion spawns 6 children in a ring pattern
- Verify mine sits and pulses before detonating toward player
- Verify spiral creates readable oscillating lanes
- Verify projectile cap of 80 prevents performance degradation
- Start a daily challenge, play twice on same day -- verify same projectile type sequence (determinism preserved)
</verification>

<success_criteria>
- 3 new projectile types (spiral, cluster, mine) appear in gameplay at correct phase gates
- Each type is visually and mechanically distinct from existing 6 types
- Cluster and mine have child-projectile explosion mechanics
- Mine has visible telegraph (pulsing dwell) before detonation
- Projectile cap at 80 prevents runaway spawns from cluster/mine children
- Daily challenge seed determinism is preserved (all rolls use this.rng())
</success_criteria>

<output>
After completion, create `.planning/phases/05-new-mechanics/05-01-SUMMARY.md`
</output>
